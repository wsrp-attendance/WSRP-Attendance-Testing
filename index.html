<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WSRP Check‑In</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    .spinner {
      width: 40px; height: 40px; margin: 20px auto;
      border: 5px solid #ccc; border-top-color: #007bff;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h2>WSRP Student / Mentor Check‑In</h2>
  <p id="status">Checking your location…</p>
  <div id="spinner" class="spinner"></div>

  <form id="checkinForm" class="hidden">
    <input type="hidden" name="uid" id="uid">
    <input type="hidden" name="latitude" id="lat">
    <input type="hidden" name="longitude" id="lng">
    <button type="submit">Submit Check-In</button>
  </form>

  <div id="result" style="margin-top:20px;"></div>

<script>
const SCHOOL_LAT = 42.06099;
const SCHOOL_LNG = -87.94404;
const MAX_METERS = 100;
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmn0XCdPt9-cw7VxEiN2lvxd4vbAkR8bKQ81BVabaugH_8cvsxUVWUZJZGBfX6AgSqmg/exec';

function rad(d){ return d * Math.PI / 180; }
function haversine(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const dLat = rad(lat2-lat1);
  const dLng = rad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLng/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function genUID(){ return 'UID-' + Math.random().toString(36).substring(2, 11); }

function enableForm(uid, lat, lng) {
  document.getElementById('uid').value = uid;
  document.getElementById('lat').value = lat.toFixed(6);
  document.getElementById('lng').value = lng.toFixed(6);

  document.getElementById('checkinForm').classList.remove('hidden');
  document.getElementById('spinner').style.display = 'none';
  document.getElementById('status').textContent = 'Location verified – please check in.';
}

function showError(msg) {
  document.getElementById('spinner').style.display = 'none';
  document.getElementById('status').textContent = msg;
}

document.getElementById('checkinForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append('uid', document.getElementById('uid').value);
  formData.append('latitude', document.getElementById('lat').value);
  formData.append('longitude', document.getElementById('lng').value);

  document.getElementById('result').textContent = 'Submitting…';

  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData,
    mode: 'cors'
  })
  .then(response => response.text())
  .then(html => {
    document.getElementById('result').innerHTML = html;
    document.getElementById('checkinForm').style.display = 'none';
  })
  .catch(err => {
    document.getElementById('result').textContent = 'Submission failed: ' + err.message;
  });
});

document.addEventListener('DOMContentLoaded', () => {
  if (!navigator.geolocation) {
    showError('Geolocation not supported by your browser.');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const dist = haversine(lat, lng, SCHOOL_LAT, SCHOOL_LNG);

      if (dist <= MAX_METERS) {
        enableForm(genUID(), lat, lng);
      } else {
        showError('You are not on school grounds.');
      }
    },
    err => showError('Location error: ' + err.message),
    { enableHighAccuracy: true, timeout: 10000 }
  );
});
</script>
</body>
</html>
